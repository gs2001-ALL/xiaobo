### 整体实现思路

1. 3D小波变换（DWT3D）
- 对输入视频张量 [batch, channels, time, height, width] 进行3D小波分解，获得多级、多方向的小波系数（包括高频和低频分量）。
- 以字典形式组织各层级、各通道、各方向的系数。

2. 多尺度小波系数融合
- 仅选用高频系数，经过尺寸对齐（上采样）后，堆叠为 [batch, num_coeffs, channels, time, height, width]。
- 通过自定义的多头注意力机制（AdvancedWaveletCoeffAttention）对不同层级/方向的系数进行加权融合，得到统一的特征张量 [batch, channels, time, height, width]。

3. 时空图构建
- 将融合特征划分为网格块，每个网格块在每一帧作为一个节点。
- 节点特征为网格块的多种统计量（均值、方差、能量、偏度等）。
- 节点间通过空间邻接（同帧相邻网格）和时间邻接（相同网格跨帧）建立边，形成时空图。

4. 门控图卷积网络（GatedGCN）
- 对每个batch的图，应用两层GCN并引入门控机制，融合原始与卷积特征，增强表达能力。
- 输出每个节点的高维特征。
5. 帧级特征聚合与后处理

- 对每帧所有节点特征做全局平均池化，获得帧级特征 [batch, time, out_channels]。
- 通过多头注意力、BatchNorm、Dropout等进一步处理特征。
6. 异常分数输出

- 主干路径和残差路径分别通过MLP输出异常分数，最终加权融合。
- 分数经过softplus激活、标准化、温度缩放和clamp，保证数值稳定和区分度。
- 若小波分解导致时间维度变化，自动上采样回原始帧数。

### 模块流程及输入输出维度

输入:           [B, C, T, H, W]
  │
3D小波变换:      → 多级系数字典 {level, channel, coeff: [B, 1, t', h', w']}
  │
小波系数融合:    → [B, C, T', H', W']
  │
时空图构建:      → [B个图，每图: x [num_nodes, feat_dim], edge_index]
  │
门控GCN:         → [num_nodes, out_channels]
  │
帧级池化:        → [T', out_channels]
  │
批次堆叠:        → [B, T', out_channels]
  │
注意力/归一化:    → [B, T', out_channels]
  │
输出投影:        → [B, T', 1] → squeeze → [B, T']
  │
归一化/激活:      → [B, T']
  │
时间对齐:        → [B, T]
输出:           [B, T]

### 改进建议
1. 小波系数融合方式
- 问题：当前只用高频系数，且简单堆叠后用注意力融合，可能忽略了不同层级/方向的物理意义。
- 建议：可考虑为不同层级/方向设计独立的权重或分支，或引入更细粒度的可学习融合策略（如 Transformer 融合）。
2. 节点特征设计
- 问题：节点特征仅用统计量（均值、方差等），可能损失了空间结构信息。
- 建议：可直接用网格块的卷积特征或引入更复杂的 patch embedding（如 ViT 的 patch embedding）。
3. GCN层数与结构
- 问题：GCN层数较浅（2层），可能不足以捕获复杂的时空依赖。
- 建议：可尝试更深的GCN或引入残差/跳连结构，或尝试 GAT、GraphSAGE 等更强的图神经网络。
4. 注意力机制位置
- 问题：注意力机制只在特征聚合后应用一次，未在图卷积或小波融合阶段深度参与。
- 建议：可在图卷积前后都引入注意力，或在小波系数融合时用多层注意力。
5. 异常分数归一化与激活
- 问题：分数归一化和 softplus 激活后再 clamp，可能导致梯度消失或分布偏移。
- 建议：可考虑只用 softplus 或 sigmoid，不必多次 clamp，归一化可用 LayerNorm 替代。
6. 异常值处理方式
- 问题：遇到异常值直接用零或均值填充，可能掩盖模型本身的问题。
- 建议：可记录异常发生频率，或在训练时引入异常检测 loss，提升模型鲁棒性。